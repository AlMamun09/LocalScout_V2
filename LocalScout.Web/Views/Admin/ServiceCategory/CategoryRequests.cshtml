@model IEnumerable<LocalScout.Application.DTOs.CategoryRequestDto>
@{
    ViewData["Title"] = "Service Category Requests";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

@Html.AntiForgeryToken()

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Service Category Requests</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item active">Category Requests</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="card card-warning card-outline">
            <div class="card-header">
                <h3 class="card-title">Pending Requests</h3>
            </div>
            <div class="card-body">
                @if (!Model.Any())
                {
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No pending category requests.</p>
                    </div>
                }
                else
                {
                    <table id="requestsTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th style="width: 22%;">Provider</th>
                                <th style="width: 22%;">Requested Category</th>
                                <th style="width: 32%;">Description</th>
                                <th style="width: 14%;">Requested Date</th>
                                <th style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                var profileImg = !string.IsNullOrEmpty(item.ProviderProfilePictureUrl)
                                    ? item.ProviderProfilePictureUrl
                                    : "/images/default-avatar.png";
                                <tr data-id="@item.CategoryRequestId">
                                    <td>
                                        <a href="#" class="provider-link d-flex align-items-center"
                                           data-provider-id="@item.ProviderId" style="text-decoration: none; color: inherit;">
                                            <img src="@profileImg" alt="@item.ProviderName"
                                                 class="img-circle mr-2" style="width: 35px; height: 35px; object-fit: cover;">
                                            <span class="text-primary font-weight-bold">@item.ProviderName</span>
                                        </a>
                                    </td>
                                    <td><strong>@item.RequestedCategoryName</strong></td>
                                    <td>@(item.Description ?? "-")</td>
                                    <td>@item.CreatedAt.ToString("MMM dd, yyyy")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-success" onclick="openApproveModal('@item.CategoryRequestId', this)" title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectRequest('@item.CategoryRequestId', this)" title="Reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</section>

<!-- Provider Details Modal -->
<div class="modal fade" id="providerDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Provider Details</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="providerDetailsContent">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-create-edit">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">Approve Category Request</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="modalContent"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var requestsTable;
        var currentRow;

        $(function () {
            if ($("#requestsTable").length) {
                requestsTable = $("#requestsTable").DataTable({
                    "responsive": true,
                    "autoWidth": false,
                    "pageLength": 10,
                    "columnDefs": [
                        { "targets": 0, "width": "22%" },
                        { "targets": 1, "width": "22%" },
                        { "targets": 2, "width": "32%" },
                        { "targets": 3, "width": "14%" },
                        { "targets": 4, "width": "10%", "orderable": false, "searchable": false }
                    ]
                });
            }

            // Provider link click handler
            $('.provider-link').on('click', function(e) {
                e.preventDefault();
                var providerId = $(this).data('provider-id');

                $('#providerDetailsContent').html('<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div>');
                $('#providerDetailsModal').modal('show');

                $.get('@Url.Action("GetProviderDetails", "CategoryRequest")', { id: providerId }, function(html) {
                    $('#providerDetailsContent').html(html);
                }).fail(function() {
                    $('#providerDetailsContent').html('<div class="alert alert-danger">Failed to load provider details.</div>');
                });
            });
        });

        function openApproveModal(id, btn) {
            currentRow = $(btn).closest('tr');
            $('#modalTitle').text('Approve Category Request');
            $('#modal-create-edit').modal('show');
            $('#modalContent').html('<div class="text-center p-4"><div class="spinner-border text-primary"></div><p class="mt-2">Loading...</p></div>');

            $.get('@Url.Action("GetApproveModal", "CategoryRequest")', { id: id }, function (html) {
                $('#modalContent').html(html);
                window.handleCategoryModalSuccess = function (response) {
                    if (requestsTable) {
                        requestsTable.row(currentRow).remove().draw(false);
                    } else {
                        currentRow.remove();
                    }
                };
            }).fail(function () {
                $('#modalContent').html('<div class="alert alert-danger">Failed to load approval form.</div>');
            });
        }

        function rejectRequest(id, btn) {
            Swal.fire({
                title: 'Reject Request?',
                input: 'textarea',
                inputLabel: 'Rejection Reason (Required)',
                inputPlaceholder: 'Enter the reason for rejection...',
                inputValidator: (value) => {
                    if (!value || !value.trim()) {
                        return 'Reason is required!';
                    }
                },
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Reject'
            }).then((result) => {
                if (result.isConfirmed) {
                    AjaxClient.post('@Url.Action("Reject", "CategoryRequest")',
                        { id: id, reason: result.value },
                        function (res) {
                            Swal.fire('Rejected', res.message, 'success');
                            if (requestsTable) {
                                requestsTable.row($(btn).closest('tr')).remove().draw(false);
                            } else {
                                $(btn).closest('tr').remove();
                            }
                        },
                        function (xhr) { Swal.fire('Error', 'Failed to reject', 'error'); }
                    );
                }
            });
        }
    </script>
}
