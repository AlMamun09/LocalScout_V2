@model IEnumerable<LocalScout.Application.DTOs.ServiceProviderDto>
@{
    // Fallback title if not set by Controller
    ViewData["Title"] = ViewData["Title"] ?? "Provider Management";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";

    var isVerificationPage = ViewData["Title"]?.ToString() == "Provider Verification Requests";
}

@Html.AntiForgeryToken()

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">@ViewData["Title"]</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item active">Providers</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">Service Providers List</h3>
            </div>
            <div class="card-body">
                <table id="providersTable" class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Provider Info</th>
                            <th>Business Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Joined Date</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Verification</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var provider in Model)
                        {
                            <tr data-provider-id="@provider.Id">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="@(provider.ProfilePictureUrl ?? "/adminlte/dist/img/user2-160x160.jpg")"
                                             class="img-circle img-size-32 mr-2"
                                             style="object-fit:cover; width: 32px; height: 32px;">
                                        <span>@provider.FullName</span>
                                    </div>
                                </td>
                                <td><span class="font-weight-bold text-primary">@provider.BusinessName</span></td>
                                <td>@provider.Email</td>
                                <td>@provider.PhoneNumber</td>
                                <td>@provider.CreatedAt.ToString("MMM dd, yyyy")</td>

                                <!-- Status Column -->
                                <td class="text-center align-middle">
                                    <span class="badge @(provider.IsActive ? "badge-success" : "badge-warning") status-badge" style="font-size: 0.9em;">
                                        @(provider.IsActive ? "Active" : "Blocked")
                                    </span>
                                </td>

                                <!-- Verification Column -->
                                <td class="text-center align-middle">
                                    @if (provider.IsVerified)
                                    {
                                        <span class="badge badge-info" style="font-size: 0.9em;"><i class="fas fa-check-circle"></i> Verified</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary" style="font-size: 0.9em;"><i class="fas fa-clock"></i> Unverified</span>
                                    }
                                </td>

                                <td class="align-middle">
                                    <div class="d-flex">
                                        <!-- View Details Button -->
                                        <button class="btn btn-sm btn-primary mr-1" onclick="viewProviderDetails('@provider.Id')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>

                                        <!-- Block/Unblock Button: HIDE if on Verification Request Page -->
                                        @if (!isVerificationPage)
                                        {
                                            <button class="btn btn-sm @(provider.IsActive ? "btn-danger" : "btn-success") btn-status mr-1"
                                                    onclick="toggleProviderStatus('@provider.Id', this)"
                                                    title="@(provider.IsActive ? "Block" : "Unblock")">
                                                <i class="fas @(provider.IsActive ? "fa-ban" : "fa-check")"></i>
                                            </button>
                                        }

                                        <!-- Inline Verification Actions (Optional, can be handled inside modal only) -->
                                        @if (!provider.IsVerified && isVerificationPage)
                                        {
                                            <button class="btn btn-sm btn-success mr-1" onclick="approveProvider('@provider.Id', this)" title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="rejectProvider('@provider.Id', this)" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Modal for Provider Details -->
<div class="modal fade" id="modal-provider-details">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Provider Details</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="provider-details-content">
                <!-- AJAX Content Loads Here -->
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Custom Rejection Reason -->
<div class="modal fade" id="modal-reject-reason" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h4 class="modal-title"><i class="fas fa-times-circle mr-2"></i>Reject Verification</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reject-provider-id" />
                <div class="form-group">
                    <label for="rejection-reason">Rejection Reason</label>
                    <textarea id="rejection-reason" class="form-control" rows="4"
                              placeholder="Enter the reason for rejection (optional). If left empty, a default message will be used."></textarea>
                    <small class="text-muted">
                        Default: "Documents did not meet requirements."
                    </small>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    <i class="fas fa-arrow-left mr-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmRejectProvider()">
                    <i class="fas fa-times mr-1"></i> Confirm Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Block Reason -->
<div class="modal fade" id="modal-block-provider-reason" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h4 class="modal-title text-white"><i class="fas fa-ban mr-2"></i>Block Provider</h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="block-provider-id" />
                <div class="form-group">
                    <label for="block-provider-reason"><strong>Block Reason</strong> <span class="text-danger">*</span></label>
                    <textarea id="block-provider-reason" class="form-control" rows="4"
                              placeholder="Enter the reason for blocking this provider (required)."></textarea>
                    <small class="text-muted">
                        This reason will be shown to the provider in their notification.
                    </small>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    <i class="fas fa-arrow-left mr-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmBlockProvider()">
                    <i class="fas fa-ban mr-1"></i> Confirm Block
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var dataTable;
        var currentProviderId = null; // Track the provider being acted upon

        $(function () {
            dataTable = $("#providersTable").DataTable({
                "responsive": true, "autoWidth": false, "pageLength": 10, "order": [[4, "desc"]]
            });
        });

        // Helper function to remove row by provider ID
        function removeRowByProviderId(providerId) {
            var $row = $('tr[data-provider-id="' + providerId + '"]');
            if ($row.length) {
                dataTable.row($row).remove().draw(false);
            }
        }

        // --- View Details ---
        function viewProviderDetails(id) {
            currentProviderId = id; // Store for potential actions from modal
            $('#modal-provider-details').modal('show');
            $('#provider-details-content').html('<div class="text-center py-3"><div class="spinner-border text-primary"></div></div>');

            AjaxClient.get('@Url.Action("GetProviderDetails", "Admin")?id=' + id,
                function (response) { $('#provider-details-content').html(response); },
                function () { $('#provider-details-content').html('<p class="text-danger text-center">Error loading details.</p>'); }
            );
        }

        // --- Toggle Status (Block/Unblock) ---
        var currentBlockProviderBtn = null;

        function toggleProviderStatus(id, btn) {
            var $btn = $(btn);
            var isActive = $btn.hasClass('btn-danger');
            var action = isActive ? "Block" : "Unblock";

            if (isActive) {
                // Blocking - show reason modal
                $('#block-provider-id').val(id);
                $('#block-provider-reason').val('');
                $('#modal-block-provider-reason').modal('show');
                currentBlockProviderBtn = btn;
            } else {
                // Unblocking - confirm directly
                Swal.fire({
                    title: 'Unblock Provider?',
                    text: 'This provider will regain access to all features.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, Unblock!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        performToggleStatus(id, btn, null);
                    }
                });
            }
        }

        function confirmBlockProvider() {
            var providerId = $('#block-provider-id').val();
            var reason = $('#block-provider-reason').val().trim();

            if (!reason) {
                Swal.fire({
                    title: 'Reason Required',
                    text: 'Please enter a reason for blocking this provider.',
                    icon: 'warning',
                    confirmButtonColor: '#d33'
                });
                return;
            }

            $('#modal-block-provider-reason').modal('hide');
            performToggleStatus(providerId, currentBlockProviderBtn, reason);
        }

        // --- Perform Toggle Status with Row Removal ---
        function performToggleStatus(id, btn, reason) {
            var $btn = $(btn);
            var $row = $btn.closest('tr');

            var data = { id: id };
            if (reason) {
                data.reason = reason;
            }

            AjaxClient.post('@Url.Action("ToggleProviderStatus", "Admin")', data,
                function (response) {
                    $('#modal-provider-details').modal('hide');

                    Swal.fire({
                        title: 'Success!',
                        text: response.message || 'Provider status updated successfully',
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        dataTable.row($row).remove().draw(false);
                    });
                },
                function (xhr) {
                    Swal.fire({
                        title: 'Error',
                        text: xhr.responseJSON?.message || 'Failed to update provider status',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#d33'
                    });
                }
            );
        }

        // --- Approve Provider with Row Removal ---
        function approveProvider(id, btn) {
            currentProviderId = id;

            Swal.fire({
                title: 'Approve Provider?',
                text: 'This provider will be verified and publicly visible.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                confirmButtonText: 'Yes, Approve!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    performApprove(id);
                }
            });
        }

        // --- Perform Approve with Row Removal ---
        function performApprove(id) {
            Swal.fire({
                title: 'Processing...',
                text: 'Approving provider verification',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            AjaxClient.post('@Url.Action("ApproveProvider", "Admin")', { id: id },
                function (response) {
                    $('#modal-provider-details').modal('hide');

                    Swal.fire({
                        title: 'Approved!',
                        text: response.message || 'Provider approved successfully.',
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        // Remove row from DataTable
                        removeRowByProviderId(id);
                    });
                },
                function (xhr) {
                    Swal.fire({
                        title: 'Error',
                        text: xhr.responseJSON?.message || 'Failed to approve provider',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#d33'
                    });
                }
            );
        }

        // --- Reject Provider - Opens Custom Reason Modal ---
        function rejectProvider(id, btn) {
            currentProviderId = id;

            // Close details modal if open
            $('#modal-provider-details').modal('hide');

            // Store provider ID and clear previous reason
            $('#reject-provider-id').val(id);
            $('#rejection-reason').val('');

            // Show rejection reason modal
            $('#modal-reject-reason').modal('show');
        }

        // --- Confirm Rejection with Row Removal ---
        function confirmRejectProvider() {
            var providerId = $('#reject-provider-id').val();
            var reason = $('#rejection-reason').val().trim();

            // Close the modal
            $('#modal-reject-reason').modal('hide');

            // Show loading state
            Swal.fire({
                title: 'Processing...',
                text: 'Rejecting provider verification',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Send request with custom reason
            AjaxClient.post('@Url.Action("RejectProvider", "Admin")', { id: providerId, reason: reason },
                function (response) {
                    Swal.fire({
                        title: 'Rejected!',
                        text: response.message || 'Provider verification rejected.',
                        icon: 'success',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        // Remove row from DataTable instead of reloading page
                        removeRowByProviderId(providerId);
                    });
                },
                function (xhr) {
                    Swal.fire({
                        title: 'Error',
                        text: xhr.responseJSON?.message || 'Failed to reject provider',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#d33'
                    });
                }
            );
        }
    </script>
}