<!-- Notification Panel Partial -->
<div class="nav-item dropdown" id="notificationDropdown">
    <a class="nav-link" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
        <i class="far fa-bell"></i>
        <span id="notificationBadge" class="badge badge-danger navbar-badge" style="display: none;">0</span>
    </a>
    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right notification-dropdown">
        <span class="dropdown-item dropdown-header" id="notificationHeader">
            <span id="notificationCount">0</span> Notifications
        </span>
        
        <div class="dropdown-divider"></div>
        
        <div id="notificationList" class="notification-list" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center text-muted py-3">
                <i class="far fa-bell-slash fa-2x mb-2"></i>
                <p class="mb-0">No notifications</p>
            </div>
        </div>
        
        <div class="dropdown-divider"></div>
        
        <a href="#" class="dropdown-item dropdown-footer" id="markAllReadBtn">Mark all as read</a>
    </div>
</div>

<!-- Notification Detail Modal -->
<div class="modal fade" id="notificationDetailModal" tabindex="-1" role="dialog" aria-labelledby="notificationDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationDetailModalLabel">Notification Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="notificationModalBody">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.notification-dropdown {
    min-width: 350px;
}

.notification-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.2s;
    border-left: 3px solid transparent;
}

.notification-item:hover {
    background-color: #f8f9fa;
}

.notification-item.unread {
    background-color: #e3f2fd;
    border-left-color: #2196F3;
}

.notification-item .notification-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.notification-item .notification-message {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 4px;
}

.notification-item .notification-time {
    font-size: 0.8em;
    color: #999;
}

.notification-item.unread .notification-title {
    color: #1976D2;
}

#notificationBadge {
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 0.7em;
    padding: 2px 5px;
}
</style>

<script>
// Notification management script
(function() {
    let notifications = [];
    
    // Initialize on page load
    $(document).ready(function() {
        loadNotificationCount();
        loadNotifications();
        
        // Refresh every 30 seconds
        setInterval(loadNotificationCount, 30000);
    });
    
    // Load notification count
    function loadNotificationCount() {
        $.ajax({
            url: '/api/Notification/count',
            type: 'GET',
            success: function(response) {
                updateBadge(response.count);
            },
            error: function() {
                console.error('Failed to load notification count');
            }
        });
    }
    
    // Load notifications list
    function loadNotifications() {
        $.ajax({
            url: '/api/Notification/list',
            type: 'GET',
            success: function(data) {
                notifications = data;
                renderNotifications();
            },
            error: function() {
                console.error('Failed to load notifications');
            }
        });
    }
    
    // Update badge
    function updateBadge(count) {
        const badge = $('#notificationBadge');
        const countSpan = $('#notificationCount');
        
        countSpan.text(count);
        
        if (count > 0) {
            badge.text(count > 99 ? '99+' : count);
            badge.show();
        } else {
            badge.hide();
        }
    }
    
    // Render notifications
    function renderNotifications() {
        const listContainer = $('#notificationList');
        
        if (!notifications || notifications.length === 0) {
            listContainer.html(`
                <div class="text-center text-muted py-3">
                    <i class="far fa-bell-slash fa-2x mb-2"></i>
                    <p class="mb-0">No notifications</p>
                </div>
            `);
            return;
        }
        
        let html = '';
        notifications.forEach(function(notification) {
            const unreadClass = !notification.isRead ? 'unread' : '';
            html += `
                <div class="notification-item ${unreadClass}" data-id="${notification.id}">
                    <div class="notification-title">${escapeHtml(notification.title)}</div>
                    <div class="notification-message">${escapeHtml(notification.message)}</div>
                    <div class="notification-time">
                        <i class="far fa-clock"></i> ${notification.timeAgo}
                    </div>
                </div>
                <div class="dropdown-divider"></div>
            `;
        });
        
        listContainer.html(html);
        
        // Attach click handlers
        $('.notification-item').on('click', function() {
            const notificationId = $(this).data('id');
            showNotificationDetail(notificationId);
        });
    }
    
    // Show notification detail
    function showNotificationDetail(notificationId) {
        const notification = notifications.find(n => n.id === notificationId);
        
        if (!notification) {
            return;
        }
        
        // Show modal
        $('#notificationDetailModal').modal('show');
        
        // Set content
        const modalBody = $('#notificationModalBody');
        modalBody.html(`
            <div class="mb-3">
                <h6 class="text-primary">${escapeHtml(notification.title)}</h6>
                <p class="text-muted mb-2">
                    <i class="far fa-clock"></i> ${notification.timeAgo}
                </p>
            </div>
            <div class="mb-3">
                <p>${escapeHtml(notification.message)}</p>
            </div>
            ${notification.metaJson ? `<div class="alert alert-info"><pre>${escapeHtml(notification.metaJson)}</pre></div>` : ''}
        `);
        
        // Mark as read if unread
        if (!notification.isRead) {
            markAsRead(notificationId);
        }
    }
    
    // Mark notification as read
    function markAsRead(notificationId) {
        $.ajax({
            url: `/api/Notification/${notificationId}/mark-read`,
            type: 'POST',
            success: function(response) {
                // Update local notification state
                const notification = notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.isRead = true;
                }
                
                // Update UI
                updateBadge(response.unreadCount);
                renderNotifications();
            },
            error: function() {
                console.error('Failed to mark notification as read');
            }
        });
    }
    
    // Mark all as read
    $('#markAllReadBtn').on('click', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: '/api/Notification/mark-all-read',
            type: 'POST',
            success: function(response) {
                // Update all notifications
                notifications.forEach(n => n.isRead = true);
                
                // Update UI
                updateBadge(0);
                renderNotifications();
                
                // Show toast
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: 'All notifications marked as read',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            },
            error: function() {
                console.error('Failed to mark all notifications as read');
            }
        });
    });
    
    // Dropdown shown event - reload notifications
    $('#notificationDropdown').on('shown.bs.dropdown', function() {
        loadNotifications();
    });
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    // Expose functions for SignalR integration
    window.notificationPanel = {
        reload: function() {
            loadNotificationCount();
            loadNotifications();
        }
    };
})();
</script>
