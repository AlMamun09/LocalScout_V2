@using Microsoft.AspNetCore.Identity
@using LocalScout.Domain.Entities
@using LocalScout.Infrastructure.Constants
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@* Debug: Check if partial is loading *@
<!-- LoginPartial Loaded -->

@{
    var currentUser = await UserManager.GetUserAsync(User);
    var userRole = "User";

    if (SignInManager.IsSignedIn(User))
    {
        if (User.IsInRole(RoleNames.Admin)) { userRole = "Administrator"; }
        else if (User.IsInRole(RoleNames.ServiceProvider)) { userRole = "Service Provider"; }
    }

    // Helper: initials fallback
    string initials = "U";
    if (!string.IsNullOrEmpty(currentUser?.FullName))
    {
        var parts = currentUser.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) initials = parts[0].Substring(0, 1).ToUpper();
        else initials = (parts[0].Substring(0, 1) + parts[^1].Substring(0, 1)).ToUpper();
    }
}

<style>
    .nav-user-avatar {
        width: 36px;
        height: 36px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.06);
    }

    .avatar-fallback {
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: linear-gradient(135deg,#243447,#1b2a36);
        color: #fff;
        font-weight: 700;
        font-size: 0.95rem;
        border: 2px solid rgba(255,255,255,0.06);
    }

    .user-dropdown-header {
        min-width: 300px;
        padding: 0.9rem;
        background: linear-gradient(180deg, rgba(8,20,30,0.95), rgba(10,18,28,0.95));
        color: #fff;
    }

    .user-dropdown-header .role-badge {
        font-size: 11px;
        opacity: .9;
    }

    .dropdown-item .fa-fw {
        width: 1.2rem;
        text-align: center;
    }
    
    /* Force left-align dropdown headers */
    .dropdown-header {
        text-align: left !important;
    }
</style>

@if (SignInManager.IsSignedIn(User))
{
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button"
           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            @if (!string.IsNullOrEmpty(currentUser?.ProfilePictureUrl))
            {
                <img src="@currentUser.ProfilePictureUrl" alt="avatar" class="nav-user-avatar mr-2 img-circle elevation-2" />
            }
            else
            {
                <div class="avatar-fallback mr-2">@initials</div>
            }

            <div class="d-none d-md-block text-left">
                <div class="small text-dark font-weight-bold" style="line-height:1;">
                    @(currentUser?.FullName ?? "User")
                </div>
                <div class="badge badge-primary bg-primary role-badge" style="line-height:1;">@userRole</div>
            </div>
        </a>

        <div class="dropdown-menu dropdown-menu-right border-0 shadow-sm p-0" aria-labelledby="userDropdown">
            <div class="user-dropdown-header d-flex align-items-center">
                <div class="mr-3">
                    @if (!string.IsNullOrEmpty(currentUser?.ProfilePictureUrl))
                    {
                        <img src="@currentUser.ProfilePictureUrl" alt="User Image" class="nav-user-avatar img-circle elevation-2" />
                    }
                    else
                    {
                        <div class="avatar-fallback">@initials</div>
                    }
                </div>
                <div class="flex-grow-1">
                    <h6 class="m-0 font-weight-bold text-truncate">@currentUser?.FullName</h6>
                    <small class="text-white-50 d-block text-truncate">@currentUser?.Email</small>
                    <span class="badge badge-primary bg-primary role-badge mt-2">@userRole</span>
                </div>
                <div class="ml-2">
                    <a asp-area="Identity" asp-page="/Account/Manage/Index" class="btn btn-sm btn-outline-light">
                        Edit
                    </a>
                </div>
            </div>

            <div class="dropdown-divider m-0"></div>

            @* ===== ADMIN NAVIGATION ===== *@
            @if (User.IsInRole(RoleNames.Admin))
            {
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Administration</div>
                <a asp-area="" asp-controller="Admin" asp-action="Index" class="dropdown-item py-2">
                    <i class="fas fa-gauge fa-fw mr-2 text-primary"></i> Admin Dashboard
                </a>
                <a asp-area="" asp-controller="Admin" asp-action="ActiveUsers" class="dropdown-item py-2">
                    <i class="fas fa-users fa-fw mr-2 text-info"></i> Manage Users
                </a>
                <a asp-area="" asp-controller="Admin" asp-action="ActiveProviders" class="dropdown-item py-2">
                    <i class="fas fa-user-tie fa-fw mr-2 text-success"></i> Manage Providers
                </a>
                <a asp-area="" asp-controller="ServiceCategory" asp-action="ActiveCategories" class="dropdown-item py-2">
                    <i class="fas fa-folder fa-fw mr-2 text-warning"></i> Manage Categories
                </a>
                
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Reports & Analytics</div>
                <a asp-area="" asp-controller="Report" asp-action="AdminReports" class="dropdown-item py-2">
                    <i class="fas fa-chart-pie fa-fw mr-2 text-purple" style="color: #6f42c1;"></i> Platform Analytics
                </a>
                <a asp-area="" asp-controller="Admin" asp-action="AuditLog" class="dropdown-item py-2">
                    <i class="fas fa-clipboard-list fa-fw mr-2 text-secondary"></i> Audit Log
                </a>
            }

            @* ===== SERVICE PROVIDER NAVIGATION ===== *@
            @if (User.IsInRole(RoleNames.ServiceProvider))
            {
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Dashboard</div>
                <a asp-area="" asp-controller="Provider" asp-action="Index" class="dropdown-item py-2">
                    <i class="fas fa-tachometer-alt fa-fw mr-2 text-primary"></i> My Dashboard
                </a>

                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Services</div>
                <a asp-area="" asp-controller="Service" asp-action="MyServices" class="dropdown-item py-2">
                    <i class="fas fa-briefcase fa-fw mr-2 text-info"></i> My Services
                </a>
                
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Bookings & Payments</div>
                <a asp-area="" asp-controller="Booking" asp-action="ProviderBookings" class="dropdown-item py-2">
                    <i class="fas fa-calendar-check fa-fw mr-2 text-success"></i> My Bookings
                </a>
                <a asp-area="" asp-controller="Payment" asp-action="History" class="dropdown-item py-2">
                    <i class="fas fa-credit-card fa-fw mr-2 text-info"></i> Payment History
                </a>
                
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Reports</div>
                <a asp-area="" asp-controller="Report" asp-action="ProviderReports" class="dropdown-item py-2">
                    <i class="fas fa-chart-line fa-fw mr-2 text-warning"></i> Earnings Report
                </a>
            }
            
            @* ===== USER NAVIGATION ===== *@
            else if (User.IsInRole(RoleNames.User))
            {
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Dashboard</div>
                <a asp-area="" asp-controller="User" asp-action="Dashboard" class="dropdown-item py-2">
                    <i class="fas fa-home fa-fw mr-2 text-primary"></i> My Dashboard
                </a>
                
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Activity</div>
                <a asp-area="" asp-controller="Booking" asp-action="MyBookings" class="dropdown-item py-2">
                    <i class="fas fa-calendar-alt fa-fw mr-2 text-success"></i> My Bookings
                </a>
                <a asp-area="" asp-controller="Review" asp-action="MyReviews" class="dropdown-item py-2">
                    <i class="fas fa-star fa-fw mr-2 text-warning"></i> My Reviews
                </a>
                <a asp-area="" asp-controller="Payment" asp-action="UserHistory" class="dropdown-item py-2">
                    <i class="fas fa-credit-card fa-fw mr-2 text-info"></i> Payment History
                </a>
                
                <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3 pt-2">Reports</div>
                <a asp-area="" asp-controller="Report" asp-action="UserReports" class="dropdown-item py-2">
                    <i class="fas fa-chart-bar fa-fw mr-2 text-purple" style="color: #6f42c1;"></i> Activity Report
                </a>
            }

            <div class="dropdown-divider my-1"></div>

            <form asp-area="Identity" asp-page="/Account/Logout"
                  asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })" method="post" class="m-0">
                <button type="submit" class="dropdown-item text-danger py-2 font-weight-bold w-100 text-left">
                    <i class="fas fa-sign-out-alt fa-fw mr-2"></i> Logout
                </button>
            </form>
        </div>
    </li>
}
else
{
    @* ===== GUEST NAVIGATION (NOT LOGGED IN) ===== *@
    <li class="nav-item dropdown">
        <a class="btn btn-outline-primary btn-sm dropdown-toggle" href="#" id="accountDropdown" role="button"
           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user-circle mr-1"></i> Account
        </a>
        <div class="dropdown-menu dropdown-menu-right border-0 shadow" aria-labelledby="accountDropdown">
            <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3">Get Started</div>
            <a class="dropdown-item py-2" asp-area="Identity" asp-page="/Account/Login">
                <i class="fas fa-sign-in-alt fa-fw mr-2 text-primary"></i> Login
            </a>
            <a class="dropdown-item py-2" asp-area="Identity" asp-page="/Account/Register">
                <i class="fas fa-user-plus fa-fw mr-2 text-success"></i> Register
            </a>
            <div class="dropdown-divider"></div>
            <div class="dropdown-header text-uppercase small font-weight-bold text-muted px-3">For Professionals</div>
            <a class="dropdown-item py-2" asp-area="Identity" asp-page="/Account/RegisterProvider">
                <i class="fas fa-briefcase fa-fw mr-2 text-warning"></i> Become a Provider
            </a>
        </div>
    </li>
}

<script>
    // Bootstrap 4 dropdown initialization with jQuery
    $(document).ready(function() {
        // Initialize all dropdowns with Bootstrap 4
        $('[data-toggle="dropdown"]').dropdown();
        
        // Debug log
        console.log('LoginPartial loaded, jQuery version:', $.fn.jquery);
        console.log('Dropdown elements found:', $('[data-toggle="dropdown"]').length);
    });
</script>
