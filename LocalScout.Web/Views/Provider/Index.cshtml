@model LocalScout.Application.DTOs.ProviderDashboardDto
@using LocalScout.Domain.Enums

@{
    ViewData["Title"] = "Provider Dashboard";
    Layout = "~/Views/Shared/Layouts/_DashboardLayout.cshtml";

    // Determine Verification Status
    var isVerified = Model.VerificationRequest != null && Model.VerificationRequest.Status == VerificationStatus.Approved;
    var isPending = Model.VerificationRequest != null && Model.VerificationRequest.Status == VerificationStatus.Pending;
    var isRejected = Model.VerificationRequest != null && Model.VerificationRequest.Status == VerificationStatus.Rejected;
    var isNew = Model.VerificationRequest == null;
}

<!-- 1. STATUS ALERTS & UPLOAD SECTION -->
@if (!isVerified)
{
    <div class="row mb-3">
        <div class="col-12">
            <!-- Status Messages -->
            @if (isPending)
            {
                <div class="alert alert-warning shadow-sm">
                    <h5><i class="icon fas fa-hourglass-half"></i> Verification Pending</h5>
                    <p class="mb-0">
                        Your document (Submitted on: <strong>@Model.VerificationRequest.SubmittedAt.ToString("MMM dd, yyyy")</strong>)
                        is currently under review by our admin team. You will be notified once approved.
                    </p>
                </div>
            }
            else if (isRejected)
            {
                <div class="alert alert-danger shadow-sm">
                    <h5><i class="icon fas fa-ban"></i> Verification Rejected</h5>
                    <p><strong>Reason:</strong> @Model.VerificationRequest.AdminComments</p>
                    <p class="mb-0">Please address the issue and upload a valid document below to resubmit your application.</p>
                </div>
            }
            else if (isNew)
            {
                <div class="callout callout-info shadow-sm">
                    <h5><i class="fas fa-info-circle text-info"></i> Verify Your Account</h5>
                    <p>To verify your identity and start accepting bookings on LocalScout, please upload your Trade License, National ID, or Passport.</p>
                </div>
            }

            <!-- Upload Form (Shown if New or Rejected) -->
            @if (isNew || isRejected)
            {
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">Upload Verification Document</h3>
                    </div>
                    <form asp-action="SubmitVerification" asp-controller="Verification" method="post" enctype="multipart/form-data" id="verificationUploadForm">
                        <div class="card-body">
                            @Html.AntiForgeryToken()

                            <div class="form-group">
                                <label>Document Type <span class="text-danger">*</span></label>
                                <select name="DocumentType" class="form-control custom-select" required>
                                    <option value="">Select Document Type</option>
                                    <option value="NID">National ID (NID)</option>
                                    <option value="TradeLicense">Trade License</option>
                                    <option value="Passport">Passport</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Upload File <span class="text-danger">*</span></label>
                                <small class="text-muted d-block mb-2">(Supported formats: JPG, PNG, PDF - Max size: 5MB)</small>
                                <div class="input-group">
                                    <div class="custom-file">
                                        <input type="file" name="Document" class="custom-file-input" id="verificationFile" required accept=".jpg,.jpeg,.png,.pdf">
                                        <label class="custom-file-label" for="verificationFile">Choose file</label>
                                    </div>
                                </div>
                            </div>

                            @if (TempData["ErrorMessage"] != null)
                            {
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <i class="icon fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                            }

                            @if (TempData["SuccessMessage"] != null)
                            {
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <i class="icon fas fa-check"></i> @TempData["SuccessMessage"]
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                            }
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-upload mr-1"></i> Submit for Verification
                            </button>
                        </div>
                    </form>
                </div>
            }
        </div>
    </div>
}

<!-- 2. MAIN DASHBOARD CONTENT (Only Visible if Verified) -->
@if (isVerified)
{
    <!-- KPI Cards Row -->
    <div class="row">
        <div class="col-lg-3 col-6">
            <!-- Total Earnings -->
            <div class="small-box bg-success">
                <div class="inner">
                    <h3>@Model.TotalEarnings.ToString("N0") Taka</h3>
                    <p>Total Earnings</p>
                </div>
                <div class="icon">
                    <i class="fas fa-sack-dollar"></i>
                </div>
                <a href="#" class="small-box-footer">Payment History <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <!-- Total Bookings -->
            <div class="small-box bg-info">
                <div class="inner">
                    <h3>@Model.TotalBookings</h3>
                    <p>Completed Bookings</p>
                </div>
                <div class="icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <a href="#" class="small-box-footer">All Bookings <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <!-- Pending Requests -->
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3>@Model.PendingRequestsCount</h3>
                    <p>New Requests</p>
                </div>
                <div class="icon">
                    <i class="fas fa-user-clock"></i>
                </div>
                <a href="#" class="small-box-footer">Manage Requests <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <!-- Average Rating -->
            <div class="small-box bg-danger">
                <div class="inner">
                    <h3>@Model.AverageRating.ToString("0.0") <sup style="font-size: 20px">/5</sup></h3>
                    <p>Average Rating</p>
                </div>
                <div class="icon">
                    <i class="fas fa-star"></i>
                </div>
                <a href="#" class="small-box-footer">View Reviews <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
    </div>

    <!-- Recent Activity Row -->
    <div class="row">
        <!-- Left Column: Quick Profile/Status -->
        <div class="col-lg-4">
            <div class="card card-widget widget-user-2 shadow-sm">
                <!-- Add the bg color to the header using any of the bg-* classes -->
                <div class="widget-user-header bg-primary">
                    <div class="widget-user-image">
                        @if (!string.IsNullOrEmpty(Model.ProfilePictureUrl))
                        {
                            <img class="img-circle elevation-2" src="@Model.ProfilePictureUrl" alt="User Avatar" style="object-fit: cover;">
                        }
                        else
                        {
                            <div class="img-circle elevation-2 d-flex align-items-center justify-content-center bg-light text-primary" style="width: 65px; height: 65px; font-size: 1.5rem; font-weight: bold;">
                                @(Model.ProviderName.Length > 0 ? Model.ProviderName[0].ToString().ToUpper() : "P")
                            </div>
                        }
                    </div>
                    <h3 class="widget-user-username">@Model.ProviderName</h3>
                    <h5 class="widget-user-desc">@(Model.BusinessName ?? "Service Provider")</h5>
                </div>
                <div class="card-footer p-0">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a asp-controller="Service" asp-action="ProviderServices" class="nav-link">
                                Active Services <span class="float-right badge bg-primary">@Model.ActiveServicesCount</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a asp-controller="Booking" asp-action="ProviderBookings" class="nav-link">
                                Completed Jobs <span class="float-right badge bg-success">@Model.TotalBookings</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a asp-controller="Booking" asp-action="ProviderBookings" class="nav-link">
                                Pending Requests <span class="float-right badge bg-warning">@Model.PendingRequestsCount</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a asp-controller="Payment" asp-action="History" class="nav-link">
                                Total Earnings <span class="float-right badge bg-success">?@Model.TotalEarnings.ToString("N0")</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Right Column: Recent Bookings Table -->
        <div class="col-lg-8">
            <div class="card card-primary card-outline">
                <div class="card-header border-0">
                    <h3 class="card-title">Recent Booking Requests</h3>
                    <div class="card-tools">
                        <a asp-controller="Booking" asp-action="ProviderBookings" class="btn btn-tool btn-sm">
                            <i class="fas fa-bars"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-striped table-valign-middle">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>Date & Location</th>
                                <th class="text-center">Status</th>
                                <th class="text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.RecentBookings != null && Model.RecentBookings.Any())
                            {
                                foreach (var booking in Model.RecentBookings)
                                {
                                    // UI Logic: Determine badge color based on status string
                                    var badgeClass = "badge-secondary";
                                    if (booking.Status == "Pending") { badgeClass = "badge-warning"; }
                                    else if (booking.Status == "Accepted") { badgeClass = "badge-info"; }
                                    else if (booking.Status == "Completed") { badgeClass = "badge-success"; }
                                    else if (booking.Status == "Cancelled") { badgeClass = "badge-danger"; }
                                    else if (booking.Status == "Paid") { badgeClass = "badge-primary"; }

                                    <tr>
                                        <td class="font-weight-bold">@booking.CustomerName</td>
                                        <td>@booking.ServiceName</td>
                                        <td>
                                            <div class="text-muted small"><i class="far fa-calendar-alt mr-1"></i> @booking.Date</div>
                                            @if (!string.IsNullOrEmpty(booking.Location))
                                            {
                                                <div class="text-muted small"><i class="fas fa-map-marker-alt mr-1"></i> @booking.Location</div>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge @badgeClass" style="font-size: 0.9em;">@booking.Status</span>
                                        </td>
                                        <td class="text-right">
                                            <a asp-controller="Booking" asp-action="ProviderDetails" asp-route-id="@booking.BookingId" class="btn btn-sm btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                                        <p>No recent bookings found.</p>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer clearfix">
                    <a asp-controller="Booking" asp-action="ProviderBookings" class="btn btn-sm btn-secondary float-right">View All Orders</a>
                </div>
            </div>
        </div>

        
    </div>
}

@section Scripts {
    <!-- bs-custom-file-input for proper file name display -->
    <script src="~/adminlte/plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>

    <script>
        $(function () {
            // Initialize custom file input for the upload form
            bsCustomFileInput.init();

            $('#verificationUploadForm').on('submit', function(e) {
                var formData = new FormData(this);
                console.log('Form submitting...');
                console.log('Document Type:', formData.get('DocumentType'));
                console.log('Document File:', formData.get('Document'));
                
                // Validate file is selected
                var fileInput = document.getElementById('verificationFile');
                if (fileInput.files.length === 0) {
                    e.preventDefault();
                    alert('Please select a file to upload.');
                    return false;
                }
                
                console.log('File selected:', fileInput.files[0].name);
            });
        });
    </script>
}
