@model LocalScout.Application.DTOs.BookingDTOs.BookingDetailsForUserDto
@using LocalScout.Domain.Enums

@{
    ViewData["Title"] = "Booking Details";
    Layout = "~/Views/Shared/Layouts/_DashboardLayout.cshtml";
    
    var badgeClass = Model.Status switch
    {
        BookingStatus.PendingProviderReview => "badge-warning",
        BookingStatus.AcceptedByProvider => "badge-info",
        BookingStatus.AwaitingPayment => "badge-info",
        BookingStatus.PaymentReceived => "badge-primary",
        BookingStatus.InProgress => "badge-primary",
        BookingStatus.JobDone => "badge-success",
        BookingStatus.Completed => "badge-success",
        BookingStatus.Cancelled => "badge-danger",
        BookingStatus.Disputed => "badge-danger",
        _ => "badge-secondary"
    };
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Booking Details</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-controller="User" asp-action="Dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="MyBookings">My Bookings</a></li>
                    <li class="breadcrumb-item active">Details</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column - Booking Info -->
    <div class="col-md-8">
        <!-- Status Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle mr-2"></i>Booking Status
                </h5>
                <span class="badge @badgeClass" style="font-size: 1em; padding: 8px 15px;">@Model.StatusDisplay</span>
            </div>
            <div class="card-body">
                <!-- Progress Timeline -->
                <div class="timeline-progress mb-4">
                    @{
                        // Determine if job has been started (InProgress or later)
                        var isStarted = Model.Status == BookingStatus.InProgress || 
                                       Model.Status == BookingStatus.JobDone || 
                                       Model.Status == BookingStatus.Completed ||
                                       Model.JobDoneAt.HasValue;
                        
                        var steps = new[] {
                            ("Requested", Model.CreatedAt != default, Model.CreatedAt),
                            ("Accepted", Model.AcceptedAt.HasValue, Model.AcceptedAt),
                            ("Started", isStarted, isStarted ? (DateTime?)DateTime.Now : null),
                            ("Job Done", Model.JobDoneAt.HasValue, Model.JobDoneAt),
                            ("Completed", Model.CompletedAt.HasValue, Model.CompletedAt)
                        };
                    }
                    <div class="d-flex justify-content-between">
                        @foreach (var (label, completed, date) in steps)
                        {
                            <div class="text-center" style="flex: 1;">
                                <div class="rounded-circle d-inline-flex align-items-center justify-content-center @(completed ? "bg-success" : "bg-secondary")" style="width: 40px; height: 40px;">
                                    <i class="fas @(completed ? "fa-check" : "fa-circle") text-white"></i>
                                </div>
                                <p class="small mb-0 mt-1 @(completed ? "text-success font-weight-bold" : "text-muted")">@label</p>
                                @if (date.HasValue && completed && label != "Started")
                                {
                                    <small class="text-muted">@date.Value.ToString("MMM dd")</small>
                                }
                            </div>
                        }
                    </div>
                </div>

                @if (Model.Status == BookingStatus.Cancelled)
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle mr-2"></i>
                        <strong>This booking has been cancelled.</strong>
                    </div>
                }
                
                @if (Model.Status == BookingStatus.InProgress)
                {
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <strong>Job is currently in progress.</strong> The provider is working on your service.
                    </div>
                }
                
                @if (Model.Status == BookingStatus.JobDone)
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Job completed!</strong> Please make the payment to confirm completion.
                    </div>
                }
            </div>
        </div>

        <!-- Service Details Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-briefcase mr-2"></i>Service Details</h5>
            </div>
            <div class="card-body">
                <div class="d-flex">
                    @if (!string.IsNullOrEmpty(Model.ServiceImagePath))
                    {
                        <img src="@Model.ServiceImagePath" alt="Service" class="img-thumbnail mr-3" style="width: 120px; height: 120px; object-fit: cover;">
                    }
                    <div>
                        <h4>@Model.ServiceName</h4>
                        @if (!string.IsNullOrEmpty(Model.ServiceDescription))
                        {
                            <p class="text-muted">@Model.ServiceDescription</p>
                        }
                        <p class="mb-0">
                            <strong>Starting Price:</strong> Tk @Model.ServiceMinPrice.ToString("N0") @Model.ServicePricingUnit
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Your Request Details -->
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0">
                    <i class="fas fa-clipboard-list mr-2"></i>Your Request
                </h6>
            </div>

            <div class="card-body py-3">

                <!-- Request Meta -->
                <div class="flex flex-wrap text-sm text-gray-700 mb-3">

                    <div class="w-full md:w-1/2 mb-2">
                        <i class="fas fa-calendar-alt text-primary mr-1"></i>
                        <span class="font-semibold">Requested:</span>
                        @Model.CreatedAt.ToString("MMM dd, yyyy · hh:mm tt")
                    </div>

                    @if (!string.IsNullOrEmpty(Model.ConfirmedScheduleFormatted))
                    {
                        <div class="w-full md:w-1/2 mb-2">
                            <i class="fas fa-check-circle text-success mr-1"></i>
                            <span class="font-semibold">Confirmed:</span>
                            <span class="text-success">@Model.ConfirmedScheduleFormatted</span>
                        </div>
                    }

                    <div class="w-full md:w-1/2 mb-2">
                        <i class="fas fa-map-marker-alt text-danger mr-1"></i>
                        <span class="font-semibold">Location:</span>
                        @(Model.AddressArea ?? "Not specified")
                    </div>
                </div>

                <!-- User Notes -->
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <div class="bg-gray-50 border rounded p-3 text-sm mb-4">
                        <div class="font-semibold mb-1 text-gray-800">
                            <i class="fas fa-comment text-info mr-1"></i>Your Notes
                        </div>
                        <div class="text-gray-700 leading-relaxed">
                            @Model.Description
                        </div>
                    </div>
                }

                <!-- Image Gallery -->
                @if (Model.ImagePaths != null && Model.ImagePaths.Any())
                {
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h6 class="mb-0 text-sm font-semibold">
                                <i class="fas fa-images text-success mr-1"></i>
                                Images (@Model.ImagePaths.Count)
                            </h6>
                            <span class="text-xs text-muted">
                                Click to enlarge
                            </span>
                        </div>

                        <div class="flex flex-wrap -mx-1">
                            @foreach (var img in Model.ImagePaths)
                            {
                                <div class="w-1/5 px-1 mb-2">
                                    <a href="@img"
                                       data-lightbox="booking-images"
                                       data-title="Booking Image"
                                       class="block">
                                        <img src="@img"
                                             alt="Booking image"
                                             class="w-full h-[120px] object-cover rounded border hover:scale-105 transition-transform duration-200" />
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Price & Payment -->
        @if (Model.NegotiatedPrice.HasValue)
        {
            <div class="card card-success">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave mr-2"></i>Price & Payment</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h3 class="text-success mb-0">Tk @Model.NegotiatedPrice.Value.ToString("N0")</h3>
                            <p class="text-muted mb-0">Negotiated Final Price</p>
                        </div>
                        <div class="col-md-6 text-right">
                            @if (Model.CanPay)
                            {
                                <form asp-controller="Payment" asp-action="Initiate" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="bookingId" value="@Model.BookingId" />
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-credit-card mr-2"></i>Pay Now with SSLCommerz
                                    </button>
                                </form>
                            }
                            else if (Model.PaymentReceivedAt.HasValue)
                            {
                                <span class="badge badge-success" style="font-size: 1em; padding: 10px 20px;">
                                    <i class="fas fa-check-circle mr-1"></i> Paid on @Model.PaymentReceivedAt.Value.ToString("MMM dd, yyyy")
                                </span>
                            }
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(Model.ProviderNotes))
                    {
                        <hr>
                        <p><strong>Provider's Notes:</strong></p>
                        <p class="bg-light p-3 rounded">@Model.ProviderNotes</p>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Right Column - Provider Info -->
    <div class="col-md-4">
        <!-- Provider Information -->
        <div class="card card-primary card-outline">
            <div class="card-header py-2">
                <h6 class="mb-0">
                    <i class="fas fa-user-tie mr-2"></i>Service Provider
                </h6>
            </div>

            <div class="card-body text-center py-3">

                <!-- Provider Image (Centered) -->
                @if (!string.IsNullOrEmpty(Model.ProviderProfilePicture))
                {
                    <img src="@Model.ProviderProfilePicture"
                         class="img-circle mb-3 mx-auto d-block"
                         style="width: 90px; height: 90px; object-fit: cover;">
                }
                else
                {
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3"
                         style="width: 90px; height: 90px;">
                        <i class="fas fa-user fa-2x text-white"></i>
                    </div>
                }

                <!-- Name -->
                <h5 class="mb-1 font-weight-bold">@Model.ProviderName</h5>

                <!-- Business Name -->
                @if (!string.IsNullOrEmpty(Model.ProviderBusinessName))
                {
                    <p class="text-muted small mb-1">@Model.ProviderBusinessName</p>
                }

                <!-- Verified Badge -->
                @if (Model.IsProviderVerified)
                {
                    <span class="badge badge-success mt-2">
                        <i class="fas fa-check-circle mr-1"></i>Verified Provider
                    </span>
                }

            </div>

            <!-- Contact Info -->
            @if (Model.CanSeeProviderContact)
            {
                <div class="card-footer bg-light py-3">
                    <h6 class="text-primary mb-3 text-center">
                        <i class="fas fa-address-card mr-1"></i>Contact Information
                    </h6>

                    <div class="d-flex flex-column">
                        @if (!string.IsNullOrEmpty(Model.ProviderPhone))
                        {
                            <a href="tel:@Model.ProviderPhone"
                               class="btn btn-success btn-block mb-2">
                                <i class="fas fa-phone mr-2"></i>
                                @Model.ProviderPhone
                            </a>
                        }

                        @if (!string.IsNullOrEmpty(Model.ProviderEmail))
                        {
                            <a href="mailto:@Model.ProviderEmail"
                               class="btn btn-info btn-block mb-2">
                                <i class="fas fa-envelope mr-2"></i>
                                @Model.ProviderEmail
                            </a>
                        }

                        @if (!string.IsNullOrEmpty(Model.ProviderAddress))
                        {
                            <p class="mb-0 text-muted text-sm text-center">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                @Model.ProviderAddress
                            </p>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="card-footer bg-light text-center py-3">
                    <i class="fas fa-lock fa-lg text-muted mb-2"></i>
                    <p class="text-muted small mb-0">
                        Provider contact details will be shown after they accept your booking.
                    </p>
                </div>
            }
        </div>

        <!-- Actions Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs mr-2"></i>Actions</h5>
            </div>
            <div class="card-body">
                @* JobDone status - Show only Pay Now button *@
                @if (Model.Status == BookingStatus.JobDone)
                {
                    <form asp-controller="Payment" asp-action="Initiate" method="post" class="mb-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="bookingId" value="@Model.BookingId" />
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-credit-card mr-2"></i>Pay Tk @Model.NegotiatedPrice?.ToString("N0")
                        </button>
                    </form>
                }
                else
                {
                    @if (Model.CanPay)
                    {
                        <form asp-controller="Payment" asp-action="Initiate" method="post" class="mb-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="bookingId" value="@Model.BookingId" />
                            <button type="submit" class="btn btn-success btn-block">
                                <i class="fas fa-credit-card mr-2"></i>Pay Tk @Model.NegotiatedPrice?.ToString("N0")
                            </button>
                        </form>
                    }
                    
                    @if (Model.CanConfirmCompletion)
                    {
                        <button type="button" class="btn btn-success btn-block btn-confirm-completion mb-2" data-booking-id="@Model.BookingId">
                            <i class="fas fa-check-circle mr-2"></i>Confirm Job Completion
                        </button>
                    }
                    
                    @if (Model.CanCancel)
                    {
                        <button type="button" class="btn btn-outline-danger btn-block btn-cancel mb-2" data-booking-id="@Model.BookingId">
                            <i class="fas fa-times mr-2"></i>Cancel Booking
                        </button>
                    }
                }
                
                <a asp-action="MyBookings" class="btn btn-outline-secondary btn-block">
                    <i class="fas fa-arrow-left mr-2"></i>Back to My Bookings
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-times-circle mr-2"></i>Cancel Booking</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="cancelForm">
                <div class="modal-body">
                    <input type="hidden" id="cancelBookingId" name="BookingId" />
                    <p>Are you sure you want to cancel this booking?</p>
                    <div class="form-group">
                        <label for="cancelReason">Reason (Optional)</label>
                        <textarea class="form-control" id="cancelReason" name="Reason" rows="3" placeholder="Please provide a reason for cancellation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times mr-1"></i> Cancel Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Confirm completion
            $('.btn-confirm-completion').on('click', function() {
                var bookingId = $(this).data('booking-id');
                
                Swal.fire({
                    title: 'Confirm Job Completion',
                    text: 'Are you satisfied with the service?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    confirmButtonText: '<i class="fas fa-check-circle mr-1"></i> Confirm'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("ConfirmCompletion", "Booking")',
                            type: 'POST',
                            data: { bookingId: bookingId },
                            headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                            success: function(response) {
                                if (response.success) {
                                    Swal.fire('Completed!', response.message, 'success').then(() => location.reload());
                                } else {
                                    Swal.fire('Error', response.message, 'error');
                                }
                            },
                            error: function(xhr) {
                                Swal.fire('Error', xhr.responseJSON?.message || 'An error occurred', 'error');
                            }
                        });
                    }
                });
            });

            // Cancel
            $('.btn-cancel').on('click', function() {
                $('#cancelBookingId').val($(this).data('booking-id'));
                $('#cancelReason').val('');
                $('#cancelModal').modal('show');
            });

            $('#cancelForm').on('submit', function(e) {
                e.preventDefault();
                $.ajax({
                    url: '@Url.Action("UserCancel", "Booking")',
                    type: 'POST',
                    data: { BookingId: $('#cancelBookingId').val(), Reason: $('#cancelReason').val() },
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                    success: function(response) {
                        $('#cancelModal').modal('hide');
                        if (response.success) {
                            Swal.fire('Cancelled', response.message, 'success').then(() => location.reload());
                        } else {
                            Swal.fire('Error', response.message, 'error');
                        }
                    },
                    error: function(xhr) {
                        $('#cancelModal').modal('hide');
                        Swal.fire('Error', xhr.responseJSON?.message || 'An error occurred', 'error');
                    }
                });
            });
        });
    </script>
    @Html.AntiForgeryToken()
}
