@model List<LocalScout.Application.DTOs.BookingDTOs.BookingListItemDto>
@using LocalScout.Domain.Enums

@if (Model != null && Model.Any())
{
    foreach (var booking in Model)
    {
        var cardClass = booking.Status == BookingStatus.PendingProviderReview ? "card-warning" : 
                       booking.Status == BookingStatus.Completed ? "card-success" : "";

        <div class="card card-outline @cardClass">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            @if (booking.Status == BookingStatus.PendingProviderReview)
                            {
                                <span class="badge badge-warning mr-2">NEW</span>
                            }
                            <strong>@booking.ServiceName</strong>
                        </h5>
                        <small class="text-muted">Requested: @booking.CreatedAtFormatted</small>
                    </div>
                    <div class="text-right">
                        <span class="badge @booking.StatusBadgeClass" style="font-size: 0.9em;">@booking.StatusDisplay</span>
                        @await Html.PartialAsync("_CountdownClock", booking)
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Customer Info - ALWAYS VISIBLE TO PROVIDER -->
                    <div class="col-md-4 border-right">
                        <h6 class="text-primary mb-3"><i class="fas fa-user mr-1"></i> Customer Details</h6>
                        <div class="d-flex align-items-center mb-3">
                            @if (!string.IsNullOrEmpty(booking.UserProfilePicture))
                            {
                                <img src="@booking.UserProfilePicture" alt="Customer" class="img-circle elevation-2 mr-3" style="width: 60px; height: 60px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="bg-info rounded-circle d-inline-flex align-items-center justify-content-center mr-3" style="width: 60px; height: 60px;">
                                    <i class="fas fa-user fa-lg text-white"></i>
                                </div>
                            }
                            <div>
                                <h6 class="mb-0">@booking.UserName</h6>
                            </div>
                        </div>
                        
                        <!-- Contact Info - Always shown to provider with phone/email on buttons -->
                        <div class="bg-light p-2 rounded">
                            @if (!string.IsNullOrEmpty(booking.UserPhone))
                            {
                                <a href="tel:@booking.UserPhone" class="btn btn-success btn-block mb-2">
                                    <i class="fas fa-phone mr-1"></i> @booking.UserPhone
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(booking.UserEmail))
                            {
                                <a href="mailto:@booking.UserEmail" class="btn btn-info btn-block mb-2" style="word-break: break-all;">
                                    <i class="fas fa-envelope mr-1"></i> @booking.UserEmail
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(booking.UserAddress))
                            {
                                <p class="mb-0 small text-muted">
                                    <i class="fas fa-map-marker-alt text-danger mr-1"></i>
                                    @booking.UserAddress
                                </p>
                            }
                        </div>
                    </div>
                    
                    <!-- Booking Details -->
                    <div class="col-md-5">
                        <h6 class="text-primary mb-3"><i class="fas fa-clipboard-list mr-1"></i> Request Details</h6>
                        
                        @if (!string.IsNullOrEmpty(booking.AddressArea))
                        {
                            <p class="mb-1">
                                <i class="fas fa-map-marker-alt text-danger mr-2"></i>
                                <strong>Job Location:</strong> @booking.AddressArea
                            </p>
                        }
                        
                        @* Preferred Time Display - Prominent for Provider *@
                        @if (!string.IsNullOrEmpty(booking.PreferredTimeFormatted))
                        {
                            <div class="alert alert-info py-2 px-3 mb-2">
                                <i class="fas fa-clock mr-2"></i>
                                <strong>Preferred Time:</strong> @booking.PreferredTimeFormatted
                                @if (!booking.HasRequestedEndTime)
                                {
                                    <br>
                                    <small class="text-dark">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        You will set the end time when accepting
                                    </small>

                                }
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(booking.ConfirmedScheduleFormatted))
                        {
                            <div class="alert alert-success py-2 px-3 mb-2">
                                <i class="fas fa-check-circle mr-2"></i>
                                <strong>Confirmed:</strong> @booking.ConfirmedScheduleFormatted
                            </div>
                        }
                        
                        @* User Proposal Display *@
                        @if (booking.Status == BookingStatus.PendingProviderApproval && booking.HasProposal)
                        {
                            <div class="alert alert-warning py-2 px-3 mb-2">
                                <strong><i class="fas fa-clock mr-1"></i> Customer Proposal:</strong><br/>
                                <span class="text-primary">@booking.ProposedScheduleFormatted</span>
                                <br/><small class="text-muted">Please accept or decline this proposed time.</small>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(booking.Description))
                        {
                            <p class="mb-1">
                                <i class="fas fa-comment text-muted mr-2"></i>
                                <strong>Notes:</strong> @(booking.Description.Length > 150 ? booking.Description.Substring(0, 150) + "..." : booking.Description)
                            </p>
                        }
                        
                        <p class="mb-1">
                            <i class="fas fa-tag text-muted mr-2"></i>
                            <strong>Service Base Price:</strong> Tk @booking.ServiceMinPrice.ToString("N0")
                        </p>
                        
                        @if (booking.NegotiatedPrice.HasValue)
                        {
                            <p class="mb-1">
                                <i class="fas fa-money-bill-wave text-success mr-2"></i>
                                <strong>Your Price:</strong> <span class="text-success font-weight-bold">Tk @booking.NegotiatedPrice.Value.ToString("N0")</span>
                            </p>
                        }

                        <!-- Image Gallery Preview -->
                        @if (booking.ImagePaths != null && booking.ImagePaths.Any())
                        {
                            <div class="mt-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-images mr-1"></i> Attached Images (@booking.ImagePaths.Count)</h6>
                                <div class="row">
                                    @foreach (var imagePath in booking.ImagePaths.Take(4))
                                    {
                                        <div class="col-3 mb-2">
                                            <a href="@imagePath" data-lightbox="booking-@booking.BookingId" data-title="Booking Image">
                                                <img src="@imagePath" class="img-thumbnail" style="height: 60px; width: 100%; object-fit: cover; cursor: pointer;">
                                            </a>
                                        </div>
                                    }
                                </div>
                                @if (booking.ImagePaths.Count > 4)
                                {
                                    <small class="text-muted">+ @(booking.ImagePaths.Count - 4) more image(s)</small>
                                }
                            </div>
                        }
                    </div>
                    
                    <!-- Actions -->
                    <div class="col-md-3 text-center d-flex flex-column justify-content-center">
                        @if (booking.CanAcceptAndSetPrice)
                        {
                            <button type="button" class="btn btn-success btn-accept mb-2" 
                                    data-booking-id="@booking.BookingId" 
                                    data-service-name="@booking.ServiceName"
                                    data-customer-name="@booking.UserName"
                                    data-base-price="@booking.ServiceMinPrice"
                                    data-requested-date="@booking.RequestedDate?.ToString("yyyy-MM-dd")"
                                    data-requested-start="@booking.RequestedStartTime?.ToString(@"hh\:mm")"
                                    data-requested-end="@(booking.HasRequestedEndTime ? booking.RequestedEndTime?.ToString(@"hh\:mm") : "")"
                                    data-has-end-time="@booking.HasRequestedEndTime.ToString().ToLower()">
                                <i class="fas fa-check mr-1"></i> Accept & Set Price
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-decline" data-booking-id="@booking.BookingId">
                                <i class="fas fa-times mr-1"></i> Decline
                            </button>
                        }
                        else if (booking.Status == BookingStatus.NeedRescheduling)
                        {
                            @* Provider can propose a new time for rescheduling *@
                            <button type="button" class="btn btn-warning btn-propose-time mb-2" 
                                    data-booking-id="@booking.BookingId" 
                                    data-service-name="@booking.ServiceName"
                                    data-customer-name="@booking.UserName"
                                    data-base-price="@booking.ServiceMinPrice"
                                    data-requested-date="@booking.RequestedDate?.ToString("yyyy-MM-dd")"
                                    data-requested-start="@booking.RequestedStartTime?.ToString(@"hh\:mm")"
                                    data-requested-end="@(booking.HasRequestedEndTime ? booking.RequestedEndTime?.ToString(@"hh\:mm") : "")"
                                    data-has-end-time="@booking.HasRequestedEndTime.ToString().ToLower()">
                                <i class="fas fa-calendar-alt mr-1"></i> Propose New Time
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-decline" data-booking-id="@booking.BookingId">
                                <i class="fas fa-times mr-1"></i> Cancel
                            </button>
                        }
                        else if (booking.Status == BookingStatus.PendingProviderApproval && booking.HasProposal)
                        {
                            @* User proposed a new time - Provider can accept/reject via accept modal *@
                            <button type="button" class="btn btn-success btn-accept-user-proposal mb-2" 
                                    data-booking-id="@booking.BookingId"
                                    data-service-name="@booking.ServiceName"
                                    data-base-price="@booking.ServiceMinPrice"
                                    data-proposed-start="@booking.ProposedStartDateTime?.ToString("yyyy-MM-ddTHH:mm")"
                                    data-proposed-end="@booking.ProposedEndDateTime?.ToString("yyyy-MM-ddTHH:mm")"
                                    data-proposed-schedule="@booking.ProposedScheduleFormatted">
                                <i class="fas fa-check mr-1"></i> Accept & Set Price
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-reject-user-proposal" data-booking-id="@booking.BookingId">
                                <i class="fas fa-times mr-1"></i> Decline
                            </button>
                        }
                        else if (booking.CanStartJob)
                        {
                            <button type="button" class="btn btn-info btn-start-job mb-2" data-booking-id="@booking.BookingId">
                                <i class="fas fa-play mr-1"></i> Start Job
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-decline" data-booking-id="@booking.BookingId">
                                <i class="fas fa-times mr-1"></i> Cancel
                            </button>
                        }
                        else if (booking.CanComplete)
                        {
                            <button type="button" class="btn btn-success btn-complete mb-2" data-booking-id="@booking.BookingId">
                                <i class="fas fa-check-double mr-1"></i> Complete
                            </button>
                        }
                        else if (booking.CanMarkJobDone)
                        {
                            <button type="button" class="btn btn-primary btn-mark-done mb-2" data-booking-id="@booking.BookingId">
                                <i class="fas fa-check-circle mr-1"></i> Mark Job Done
                            </button>
                        }
                        else if (booking.CanCancel)
                        {
                            <button type="button" class="btn btn-outline-danger btn-decline" data-booking-id="@booking.BookingId">
                                <i class="fas fa-times mr-1"></i> Cancel
                            </button>
                        }
                        
                        <a asp-action="ProviderDetails" asp-route-id="@booking.BookingId" class="btn btn-outline-primary mt-2">
                            <i class="fas fa-eye mr-1"></i> View Details
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-footer text-muted small">
                <i class="far fa-clock mr-1"></i> Received @booking.CreatedAtFormatted
                @if (!string.IsNullOrEmpty(booking.AcceptedAtFormatted))
                {
                    <span class="ml-3"><i class="fas fa-check text-success mr-1"></i> Accepted @booking.AcceptedAtFormatted</span>
                }
            </div>
        </div>
    }
}
else
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">No booking requests</h4>
            <p class="text-muted">You don't have any booking requests in this category. Make sure your services are active and visible.</p>
            <a asp-controller="Service" asp-action="ActiveServices" class="btn btn-primary">
                <i class="fas fa-briefcase mr-1"></i> Manage My Services
            </a>
        </div>
    </div>
}
